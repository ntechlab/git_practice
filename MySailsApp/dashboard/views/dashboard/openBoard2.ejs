<link type="text/css" rel="stylesheet" href="/css/smoothness/jquery-ui.min.css" />
<script src="/js/dependencies/sails.io.js"></script>
<script src="/js/dependencies/jquery-2.1.1.min.js"></script>
<script src="/js/dependencies/jquery-ui.min.js"></script>
<script>

  // チケット削除
  function destroyTicket(id){
    console.log("destroyTicket:" + id);
    io.socket.get('/board/process/', {actionType:"destroy", id: id});
  }

  // チケット更新
  function updateTicket(id){
    console.log("updateTicket:"+id);
    var newContents = $('#ta_'+id).val();
    io.socket.get('/board/process/', {actionType:"update", id: id, contents: newContents});
  }

  // チケット作成
  function createTicket(x, y, color){
    console.log("createTicket:" + x + "," + y);
    io.socket.get('/board/process/', 
    {actionType:"create", 
     contents: "", 
     positionX: x + "px",
     positionY: y + "px",
     color: color,
     boardId : <%= boardId %>,
     userId : <%= loginUserId %>});
  }

  function make(data) {
   var val = data["contents"];
   var sticky = $('<div class="sticky"></div>');
   sticky.text(val);
   sticky.appendTo('#board')
      .attr('data-id', data["id"])
      .css('background-color', data["color"])
      .css('left', data["positionX"])
      .css('top', data["positionY"])
      .draggable({stop: updateFusenListener})
      .click(function(e) {
        console.log("付箋クリックイベント発生");
        var $self = $(this);
	var strWidth = $self.css("width");
	strWidth = strWidth.replace("px","");
        var width = parseInt(strWidth);
        var x = e.offsetX;
        var y = e.offsetY;
        // 付箋の右上がクリックされた場合には削除するか否かを尋ねる。
        if(width - x < 20 && y < 20){
          if(confirm("付箋を削除しますか？")){
            var id = data["id"];
            destroyTicket(id);
          }
        }
      })
      .dblclick(function() {
        var $self = $(this);
        var id0 = data["id"];
        $self.html('<textarea>' + $self.html() + '</textarea>')
          .children()
          .focus()
          .blur(function() {
            $(this).parent().html($(this).val());
            var $sticky = $self.closest('.sticky');
            updateFusen($sticky);
          });
      }).mousedown(function() {
        $('.sticky').removeClass('selected');
        $(this).addClass('selected');
      });
    return sticky;
  }
  
  // 付箋更新処理を呼び出すリスナ
  function updateFusenListener() {
    updateFusen($(this));
  }

  // 付箋更新処理
  function updateFusen($target) {
    var newData = {};
    newData["actionType"] = "update";
    newData["id"] = $target.data('id');
    newData["positionX"] = $target.css('left');
    newData["positionY"] = $target.css('top');
    newData["contents"] = $target.text();
    console.dir(newData);
    io.socket.get('/board/process/', newData);
  }

  // 戻るアクション
  function back(){
    submit("/dashboard/index");
  }

  // ログアウトアクション
  function logout(){
    submit("/auth/logout");
  }

  // 送信処理
  function submit(action){
    var form = document.forms.item(0);
    form.action = action;
    form.submit();
  }

  // jQueryオンロード処理
  $(function(){


  $("body").contextmenu({
    delegate: ".hasmenu",
    menu: [
        {title: "作成", children: [
            {title: "青", cmd: "#ccf"},
            {title: "黄", cmd: "#ffc"},
            {title: "赤", cmd: "#fcc"}
            ]}
        ],
    select: function(event, ui) {
        var $menu=$('#ui-id-1');
        var top = $('#board').offset().top;
        var left = $('#board').offset().left;
        var posX = $menu.offset().left - left;
        var posY = $menu.offset().top - top;
	createTicket(posX, posY, ui.cmd);
    }
  });

    // 付箋データをhtml上に展開。
    var ticketData = [<% for( var k in list ) {%>
      {id: <%= list[k].id %>, 
       positionX : '<%= list[k].positionX %>',
       positionY : '<%= list[k].positionY %>', 
       color : '<%= list[k].color %>',
       contents : '<%= list[k].contents %>'},
    <%}%>
    ];

    // 付箋データから付箋を作成し、ボードに追加。
    for(var i = 0; i < ticketData.length; i++){
      var data = ticketData[i];
      var sticky = make(data);
      $('#board').append(sticky);
    }

    console.log("リスナ登録");
    io.socket.get('/board/register/');

    // メッセージ受信時に呼び出される関数
    io.socket.on('room', function(msg) {
      console.log("メッセージ受信", msg);
      var data = msg['data'] || {};
      var id = data["id"];
      console.log("verb["+msg.verb+"]");
      if(msg.verb == "created"){
        console.log("チケットを作成します");
        var ms = "<tr id='"+id+"'>"
                +"<td>"+id+"</td>"
                +"<td><input type='button' onclick='destroyTicket("+id+")' value='削除'/></td>"
                +"<td><input type='button' onclick='updateTicket("+id+")' value='更新'/></td>"
                +"<td>"+data["boardId"]+"</td>"
                +"<td>"+data["createUser"]+"</td>"
                +"<td>"+data["nickname"]+"</td>"
                +"<td><textarea id='ta_"+id+"'>"+data["contents"]+"</textarea></td></tr>";

        $('#tickets').append(ms);

        var sticky = make(data);
        $('#board').append(sticky);

      } else if(msg.verb == "updated"){
        console.log("チケットを更新します:"+msg["id"]+","+data["contents"]);
        $('#ta_'+msg["id"]).val(data["contents"]);
        var $sticky = $(".sticky[data-id='"+msg['id']+"']");
        $sticky.css('left', data["positionX"]);
        $sticky.css('top', data["positionY"]);
        $sticky.text(data["contents"]);
      } else if(msg.verb == "destroyed"){
        console.log("チケットを削除します:"+msg["id"]);
        console.dir(msg);
        $('tr#'+msg["id"]).remove();
        $(".sticky[data-id='"+msg['id']+"']").remove();
      }
    });
});
</script>
<style>
table th {
  background-color:#dfd;
}

#info th {
  width:150px;
  text-align:left;
}

.sticky {
  box-shadow: 5px 5px 5px rgba(0,0,0,0.4);
  width: 250px;
  height: 100px;
  position: absolute;
  cursor: pointer;
  border: 1px solid #aaa;
  font-size:16pt;
}

textarea {
  width: 100%;
  height: 100%;
  font-size: 16pt;

}

.selected {border-color: #f44;}

.hasmenu {
//  border: 1px solid #008;
//  margin: 3px;
//  padding: 5px;
//  width: 30px;
}

.ui-widget{
  font-size: 1em;
}

.ui-menu {
  width: 90px;
}

#board {
  background-image:url(/images/background02.gif);
  background-repeat: repeat;
  position:relative;
//  background-color: #F7BE81;
  width: 1500px;
  height: 800px;
}
</style>
ログインユーザー:<%= loginUserId %><br>
<table id="info" border="1">
  <tr><th>ボードID</th><td><%= boardId %></td></tr>
  <tr><th>タイトル</th><td><%= title %></td></tr>
  <tr><th>説明</th><td><%= description %></td></tr>
</table>
<form method="POST">
  <input type="hidden" name="boardId" value="<%= boardId %>" />
  <input type="hidden" name="userId" value="<%= loginUserId %>" />
  <input type="button" value="戻る" onclick="back()" />
  <input type="button" value="ログアウト" onclick="logout()" />
<div>
  <div id="board" class="hasmenu">
</div>
</div>
<br><br>
<table id="tickets" border="1">
  <tr>
    <th>ID</th>
    <th>削除</th>
    <th>更新</th>
    <th>ボードID</th>
    <th>ユーザーID</th>
    <th>ニックネーム</th>
    <th>内容</th>
  </tr>
<% for( var i in list ) {%>
  <tr id="<%= list[i].id %>">
     <td><%= list[i].id %></td>
     <td><input type="button" onclick="destroyTicket(<%= list[i].id %>)" value="削除"/></td>
     <td><input type="button" onclick="updateTicket(<%= list[i].id %>)" value="更新"/></td>
     <td><%= list[i].boardId %></td>
     <td><%= list[i].createUser %></td>
     <td><%= list[i].nickname %></td>
     <td><textarea id="ta_<%= list[i].id %>"><%= list[i].contents %></textarea></td>
  </tr>
<% } %>
</table>
</form>
